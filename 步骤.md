# 安装工具链

```bash
$ sudo apt install git bison flex libncurses-dev build-essential python3-setuptools libssl-dev swig mtd-utils python3-dev universal-ctags libfdt-dev
```

# 创建工作空间

```bash
$ cd
$ mkdir atguigupi
$ mkdir atguigupi/output
$ cd atguigupi
$ tar -xf gcc-linaro-12.3.1-2023.06-x86_64_arm-linux-gnueabihf.tar.xz
$ mv gcc-linaro-12.3.1-2023.06-x86_64_arm-linux-gnueabihf toolchain
```

# u-boot

```bash
$ cd ~/atguigupi
$ tar -xf v2024.01.tar.gz
$ mv u-boot-2024.01 u-boot
```

u-boot设备树文件路径：`~/atguigupi/u-boot/arch/arm/dts/sun8i-v3s-atguigupi.dts`

文件内容如下：

```
/dts-v1/;
#include "sun8i-v3s.dtsi"
#include "sunxi-common-regulators.dtsi"

/ {
	model = "Atguigu Pi";
	compatible = "atguigu,atguigupi", "allwinner,sun8i-v3s";

	aliases {
		serial0 = &uart0;
		// 开启spi设备别名
		spi0 = &spi0;

	};

	chosen {
		stdout-path = "serial0:115200n8";
	};
};

&mmc0 {
	broken-cd;
	bus-width = <4>;
	vmmc-supply = <&reg_vcc3v3>;
	status = "okay";
};

&uart0 {
	pinctrl-0 = <&uart0_pb_pins>;
	pinctrl-names = "default";
	status = "okay";
};

// 开启spi设备
&spi0 {
	status = "okay";
	// 声明总线最高频率
	spi-max-frequency = <100000000>;
	// 在spi总线上声明flash芯片
	w25q256:w25q256@0 {
		compatible = "winbond,w25q256", "jedec,spi-nor";
		reg = <0x0>;
		// 声明芯片最高频率
		spi-max-frequency = <50000000>;
		#address-cells = <1>;
		#size-cells = <1>;
	};
};

```

## menuconfig

```bash
$ cd ~/atguigupi/u-boot
$ ARCH=arm CROSS_COMPILE=~/atguigupi/toolchain/bin/arm-linux-gnueabihf- make LicheePi_Zero_defconfig
$ ARCH=arm CROSS_COMPILE=~/atguigupi/toolchain/bin/arm-linux-gnueabihf- make menuconfig
```

修改 `~/atguigupi/u-boot/arch/arm/mach-sunxi/Kconfig` 文件

在1064行末尾添加 `|| MACH_SUN8I_V3S`

> 这一步做完之后，menuconfig中才会出现 `Support for SPI Flash on Allwinner SoCs in SPL` 选项！

```
1064	depends on MACH_SUN4I || MACH_SUN5I || MACH_SUN7I || MACH_SUNXI_H3_H5 || MACH_SUN50I || MACH_SUN8I_R40 || SUN50I_GEN_H6 || MACH_SUNIV || MACH_SUN8I_V3S
```

menuconfig选项

```
// 启用SPL阶段Flash支持
ARM architecture  --->
  [*] Support for SPI Flash on Allwinner SoCs in SPL
// 设置启动选项
Boot options  --->
  [*] Enable boot arguments
  (console=ttyS0,115200 panic=5 rootwait root=/dev/mtdblock3 rw rootfstype=squashfs init=/sbin/preinit)
  [*] Enable a default value for bootcmd
  (sf probe 0; sf read 0x41800000 0x80000 0x8000; sf read 0x41000000 0x88000 0x6F8000; bootz 0x41000000 - 0x41800000;) bootcmd value
Device Tree Control  --->
  // 启用我们自己的设备树
  (sun8i-v3s-atguigupi) Default Device Tree for DT control
// 进入驱动页面
Device Drivers  --->
  // 开启SPI驱动，会根据SOC型号自动选择合适驱动
  [*] SPI Support
    [*]   SPI memory extension
  // 进入MTD驱动页面。
  MTD Support  --->
    // 开启MTD驱动层支持
    [*] Enable MTD layer
    // 开启标准MTD驱动接口
    [*] Enable Driver Model for MTD drivers
    // 开启MTD对于SPI Flash的支持
    SPI Flash Support  --->
      [*] SPI Flash Core Interface support
      [*] SPI Flash bootdev support
      // 开启SPI Flash的bank切换支持，大于16M的Flash都需要开启
      [*] SPI flash Bank/Extended address register support
      // 我们使用winbond的Flash芯片，选中驱动支持
      [*] Winbond SPI flash support
```

将 `u-boot/drivers/spi/spi-sunxi.c` 的75行 `CONFIG_MACH_SUNIV` 修改为 `CONFIG_MACH_SUN8I_V3S`。

## 编译 u-boot

```bash
$ cd ~/atguigupi/u-boot
$ ARCH=arm CROSS_COMPILE=~/atguigupi/toolchain/bin/arm-linux-gnueabihf- make -j$(nproc)
$ mv u-boot-sunxi-with-spl.bin ../output
```

# linux内核

```bash
$ cd ~/atguigupi
$ tar -xf linux-6.6.25.tar.xz -C ~/atguigupi
$ mv linux-6.6.25 linux

```

设备树路径：`~/atguigupi/linux/arch/arm/boot/dts/allwinner/sun8i-v3s-atguigupi.dts`

内容如下：

```
/dts-v1/;
#include "sun8i-v3s.dtsi"
#include "sunxi-common-regulators.dtsi"

/ {
	// 改设备名字
	model = "Atguigu Pi";

	compatible = "atguigu,atguigupi", "allwinner,sun8i-v3s";

	aliases {
		serial0 = &uart0;
		// 给以太网取别名
		ethernet0 = &emac;
		// 给SPI起别名
		spi0 = &spi0;
	};

	chosen {
		stdout-path = "serial0:115200n8";
	};
};

&mmc0 {
	broken-cd;
	bus-width = <4>;
	vmmc-supply = <&reg_vcc3v3>;
	status = "okay";
};

&uart0 {
	pinctrl-0 = <&uart0_pb_pins>;
	pinctrl-names = "default";
	status = "okay";
};

// 开启以太网
&emac {
	allwinner,leds-active-low;
	status = "okay";
};

// 开启SPI和FLASH
&spi0 {
	status = "okay";
	w25q256:w25q256@0 {
		compatible = "winbond,w25q256", "jedec,spi-nor";
		reg = <0x0>;
		spi-max-frequency = <50000000>;
		#address-cells = <1>;
		#size-cells = <1>;
		// 由于Flash没有分区表，需要在设备树文件中声明flash分区
		// 这里总共分了5个区

		partitions {
			compatible = "fixed-partitions";
			#address-cells = <1>;
			#size-cells = <1>;

			partition-uboot {
				reg = <0x0 0x80000>;
				read-only;
			};
	
			partition-dtb {
				reg = <0x80000 0x8000>;
				read-only;
			};
	
			partition-kernel {
				reg = <0x88000 0x6F8000>;
				read-only;
			};
	
			partition-rootfs {
				reg = <0x780000 0x1080000>;
				read-only;
			};

			partition-data {
				reg = <0x1800000 0x800000>;
			};
		};
	};
};


```

修改 `~/atguigupi/linux/arch/arm/boot/dts/allwinner/Makefile`

在 323 行添加如下内容

```
sun8i-v3s-atguigupi.dtb \

```

## 修改menuconfig

```bash
$ cd ~/atguigupi/linux
$ ARCH=arm CROSS_COMPILE=~/atguigupi/toolchain/bin/arm-linux-gnueabihf- make sunxi_defconfig
$ ARCH=arm CROSS_COMPILE=~/atguigupi/toolchain/bin/arm-linux-gnueabihf- make menuconfig

```

需要修改的菜单

```
[*] Networking support  --->
  Networking options  --->
    // 选中ipv6协议
    <*>   The IPv6 protocol  --->
Device Drivers  --->
  // 选中mtd支持并进入子菜单
  <*> Memory Technology Device (MTD) support  --->
    // 选中spi nor flash支持并进入子菜单
    <*>   Caching block device access to MTD devices
    <*>   SPI NOR device support  --->
      // 取消4k sector擦写（和jffs2冲突）
      [ ]   Use small 4096 B erase sectors
  [*] SPI support  --->
    // 取消A10处理器的SPI支持（只留下下面的A31）
    < >   Allwinner A10 SoCs SPI controller
File systems  --->
  // 开启overlayfs支持
  <*> Overlay filesystem support
  [*] Miscellaneous filesystems  --->
    // 开启jffs2支持
    <*>   Journalling Flash File System v2 (JFFS2) support
    [*]     JFFS2 XATTR support
    // 开启squashfs支持
    <*>   SquashFS 4.0 - Squashed file system support
    [*]     Squashfs XATTR support

```

## 编译

```bash
$ ARCH=arm CROSS_COMPILE=~/atguigupi/toolchain/bin/arm-linux-gnueabihf- make -j$(nproc) zImage
$ ARCH=arm CROSS_COMPILE=~/atguigupi/toolchain/bin/arm-linux-gnueabihf- make -j$(nproc) dtbs
$ cp arch/arm/boot/zImage ../output
$ cp arch/arm/boot/dts/allwinner/sun8i-v3s-atguigupi.dtb ../output

```

# buildroot构建根文件系统

```bash
$ cd ~/atguigupi
$ tar -xf buildroot-2024.02.6.tar.gz
$ mv buildroot-2024.02.6 buildroot

```

## 修改menuconfig

```bash
$ cd ~/atguigupi/buildroot
$ make menuconfig

```

需要修改的菜单

```
Target options  --->
// arm架构，A7指令集
  Target Architecture (ARM (little endian))  --->
  Target Architecture Variant (cortex-A7)  --->
Toolchain  --->
  // 使用外部工具链，并且是自定义工具链
  Toolchain type (External toolchain)  --->
  Toolchain (Custom toolchain)  --->
  // 不用buildroot下载，我们提前准备好工具链
  Toolchain origin (Pre-installed toolchain)  --->
  // 工具链地址，只需要写到toolchain一级
  (/home/atguigu/atguigupi/toolchain) Toolchain path
  // 工具链固定前缀
  (arm-linux-gnueabihf) Toolchain prefix
  // 工具链版本
  External toolchain gcc version (12.x)  --->
  // 确认是6.1和header，这个要和我们的内核版本对应
  External toolchain kernel headers series (6.1.x)  --->
  // 使用glibc
  External toolchain C library (glibc)  --->
  // 开启C++和OpenMP支持
  [*] Toolchain has SSP support?
  [ ] Toolchain has RPC support?
  [*] Toolchain has C++ support?
  [*] Toolchain has Fortran support?
  [*] Toolchain has OpenMP support?
System configuration  --->
  // 设置hostname和欢迎信息
  (atguigupi) System hostname
  (Welcome to Atguigu Pi) System banner
  // 设置/bin、/sbin、/lib三个目录为软连接
  [*] Use symlinks to /usr for /bin, /sbin and /lib
  // 设置初始root密码
  (1)   Root password
  // 设置初始启用的网卡
  (eth0) Network interface to configure through DHCP
  // 设置语言支持
  (C zh_CN.UTF-8) Locales to keep
  // 安装时区
  [*] Install timezone info
  (Asia/Shanghai) default local time
  // 设置自定以rootfs内容
  (rootfs-overlay) Root filesystem overlay directories
Target packages  --->
  Hardware handling  --->
  // 硬件随机数生成器，增加系统随机数性能
    [*] rng-tools
  Libraries  --->
    Crypto  --->
  // 使用libressl库（替换openssl）
      ssl library (libressl)  --->
  Networking applications  --->
  // 使用dropbear ssh服务端
    [*] dropbear
    [*]   disable reverse DNS lookups
Filesystem images  --->
  // 将结果生成squashfs镜像
  [*] squashfs root filesystem

```

## 自定义rootfs内容

```bash
$ cd ~/atguigupi/buildroot
$ mkdir -p rootfs-overlay
$ cd rootfs-overlay
$ mkdir -p chroot rom overlay root etc/dropbear usr/sbin

```

## 生成preinit文件

在 `~/atguigupi/buildroot/rootfs-overlay/usr/sbin` 目录下创建文件`preinit` , 内容如下：

```
#!/bin/sh

# mount the new rootfs
mount -r -t squashfs /dev/mtdblock3 /rom
mount -t jffs2 /dev/mtdblock4 /overlay
mount -n -t overlay overlayfs:/overlay -o lowerdir=/rom,upperdir=/overlay/data,workdir=/overlay/work /chroot

# mount /dev and /sys for chroot environment
# /dev/pts, /dev/shm, /proc, /tmp and /run will be mounted by inittab from fstab
mount -t sysfs sysfs /sys
mount --rbind /sys /chroot/sys/
mount --rbind /dev /chroot/dev/

exec chroot /chroot /sbin/init

```

添加执行权限

```bash
$ chmod +x ~/atguigupi/buildroot/rootfs-overlay/usr/sbin/preinit

```

## 生成 `.profile` 文件

路径 `~/atguigupi/buildroot/rootfs-overlay/root/.profile`

```sh
HISTCONTROL=ignoredups:ignorespace
HISTSIZE=1000
HISTFILESIZE=2000

if [ -z "$debian_chroot" ] && [ -r /etc/debian_chroot ]; then
    debian_chroot=$(cat /etc/debian_chroot)
fi

if [ "$color_prompt" = yes ]; then
    PS1='${debian_chroot:+($debian_chroot)}\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
else
    PS1='${debian_chroot:+($debian_chroot)}\u@\h:\w\$ '
fi
unset color_prompt force_color_prompt

# If this is an xterm set the title to user@host:dir
case "$TERM" in
xterm*|rxvt*)
    PS1="\[\e]0;${debian_chroot:+($debian_chroot)}\u@\h: \w\a\]$PS1"
    ;;
*)
    ;;
esac

# enable color support of ls and also add handy aliases
if [ -x /usr/bin/dircolors ]; then
    test -r ~/.dircolors && eval "$(dircolors -b ~/.dircolors)" || eval "$(dircolors -b)"
    alias ls='ls --color=auto'
    #alias dir='dir --color=auto'
    #alias vdir='vdir --color=auto'

    alias grep='grep --color=auto'
    alias fgrep='fgrep --color=auto'
    alias egrep='egrep --color=auto'
fi

# some more ls aliases
alias ll='ls -lF'
alias la='ls -A'
alias l='ls -CF'

if [ -f ~/.bash_aliases ]; then
    . ~/.bash_aliases
fi

mesg n 2> /dev/null || true

```

## 生成rootfs镜像

```sh
$ cd ~/atguigupi/buildroot
$ make
$ mv output/images/rootfs.squashfs ../output

```

## 制作jffs2镜像

```bash
$ cd ~/atguigupi/buildroot
$ mkdir -p fakeroot/data fakeroot/work
$ fakeroot mkfs.jffs2 -s 0x100 -e 0x10000 --pad=0x800000 -o ../output/data.jffs2 -r fakeroot
$ rm -rf fakeroot

```

# 制作flash镜像

将 `sunxi-fel` 拷贝到 `~/atguigupi/output/` 中。

```bash
$ cd ~/atguigupi/output
$ chmod +x sunxi-fel

```

在 `~/atguigupi/output` 文件夹中创建文件 `flash.sh` , 内容如下：

```sh
#!/bin/bash
IMG_FILE="flash-image"
UBOOT_FILE="u-boot-sunxi-with-spl.bin"
DTB_FILE="sun8i-v3s-atguigupi.dtb"
KERNEL_FILE="zImage"
ROOTFS_FILE="rootfs.squashfs"
OVERLAYFS_FILE="data.jffs2"

# 制作镜像
function make_image() {
    set -e
    # 生成32M空文件
    dd if=/dev/zero of=$IMG_FILE bs=1M count=32
    # offset=0 写入uboot
    dd if=$UBOOT_FILE of=$IMG_FILE bs=1K seek=0 conv=notrunc
    # offset=512K 写入dtb
    dd if=$DTB_FILE of=$IMG_FILE bs=1K seek=512 conv=notrunc
    # offset=544K 写入内核
    dd if=$KERNEL_FILE of=$IMG_FILE bs=1K seek=544 conv=notrunc
    # offset=7.5M 写入rootfs
    dd if=$ROOTFS_FILE of=$IMG_FILE bs=1K seek=7680 conv=notrunc
    # offset=24M 写入data.jffs2
    dd if=$OVERLAYFS_FILE of=$IMG_FILE bs=1K seek=24576 conv=notrunc
}

# 检查flash是否存在
function ckeck_flash() {
    local RESULT="$(sudo ./sunxi-fel spiflash-info)"
    test "$RESULT" = "Manufacturer: Winbond (EFh), model: 40h, size: 33554432 bytes."
}

function flash_image() {
    make_image
    echo "镜像制作完成，开始刷写镜像"
    ckeck_flash && sudo ./sunxi-fel -p spiflash-write 0 $IMG_FILE || echo "没有找到Flash"
}

function flash_uboot() {
    echo "开始刷写uboot"
    ckeck_flash && sudo ./sunxi-fel -p spiflash-write 0 $UBOOT_FILE || echo "没有找到Flash"
}

function flash_dtb() {
    echo "开始刷写dtb"
    ckeck_flash && sudo ./sunxi-fel -p spiflash-write 524288 $DTB_FILE || echo "没有找到Flash"
}

function flash_kernel() {
    echo "开始刷写kernel"
    ckeck_flash && sudo ./sunxi-fel -p spiflash-write 557056 $KERNEL_FILE || echo "没有找到Flash"
}

function flash_rootfs() {
    echo "开始刷写rootfs"
    ckeck_flash && sudo ./sunxi-fel -p spiflash-write 7864320 $ROOTFS_FILE || echo "没有找到Flash"
}

function flash_data() {
    echo "开始刷写data"
    ckeck_flash && sudo ./sunxi-fel -p spiflash-write 25165824 $OVERLAYFS_FILE || echo "没有找到Flash"
}

function print_usage() {
    echo "flash image|uboot|dtb|kernel|rootfs|data|all"
}

echo "测试sudo权限"
sudo echo "成功" || echo "无法执行sudo"

for CMD in "$@"; do
    case $CMD in
    "uboot" | "dtb" | "kernel" | "rootfs" | "data") ;;
    "image")
        flash_image
        exit 0
        ;;
    "all")
        flash_uboot
        flash_dtb
        flash_kernel
        flash_rootfs
        flash_data
        exit 0
        ;;
    *)
        print_usage
        exit 1
        ;;
    esac
done

for CMD in "$@"; do
    flash_${CMD}
done

```

```sh
$ cd ~/atguigupi/output
$ chmod +x flash.sh
$ ./flash.sh image

```

## 分别烧写每个文件

单独校验flash

```sh
$ cd ~/atguigupi/output
$ sudo ./sunxi-fel spiflash-info

```

刷写uboot命令

```sh
$ sudo ./sunxi-fel -p spiflash-write 0 u-boot-sunxi-with-spl.bin

```

刷写dtb命令

```sh
$ sudo ./sunxi-fel -p spiflash-write 524288 sun8i-v3s-atguigupi.dtb

```

刷写内核

```sh
$ sudo ./sunxi-fel -p spiflash-write 557056 zImage

```

刷写rootfs

```sh
$ sudo ./sunxi-fel -p spiflash-write 7864320 rootfs.squashfs

```

刷写jffs2

```sh
$ sudo ./sunxi-fel -p spiflash-write 25165824 data.jffs2

```

## 打包成一个镜像统一烧写

制作镜像

```sh
$ sudo dd if=/dev/zero of=flash-image bs=1M count=32
$ sudo dd if=u-boot-sunxi-with-spl.bin of=flash-image bs=1K seek=0 conv=notrunc
$ sudo dd if=sun8i-v3s-atguigupi.dtb of=flash-image bs=1K seek=512 conv=notrunc
$ sudo dd if=zImage of=flash-image bs=1K seek=544 conv=notrunc
$ sudo dd if=rootfs.squashfs of=flash-image bs=1K seek=7680 conv=notrunc
$ sudo dd if=data.jffs2 of=flash-image bs=1K seek=24576 conv=notrunc

```

烧写镜像

```sh
$ sudo ./sunxi-fel -p spiflash-write 0 flash_image

```

# 按键驱动

修改设备树文件 `~/atguigupi/linux/arch/arm/boot/dts/allwinner/sun8i-v3s-atguigupi.dts` .

```
#include <dt-bindings/input/linux-event-codes.h>

&lradc {
	vref-supply = <&reg_vcc3v0>;
	status = "okay";
	button-0 {
		label = "Left";
		linux,code = <KEY_LEFT>;
		channel = <0>;
		voltage = <0>;
	};
	button-273 {
		label = "Right";
		linux,code = <KEY_RIGHT>;
		channel = <0>;
		voltage = <412698>;
	};
	button-500 {
		label = "Up";
		linux,code = <KEY_UP>;
		channel = <0>;
		voltage = <825396>;
	};
	button-692 {
		label = "Down";
		linux,code = <KEY_DOWN>;
		channel = <0>;
		voltage = <1111111>;
	};
	button-857 {
		label = "OK";
		linux,code = <KEY_OK>;
		channel = <0>;
		voltage = <1269841>;
	};
};

```

修改内核代码，路径 `~/atguigupi/linux/drivers/input/keyboard/sun4i-lradc-keys.c`

修改内容

```c
// 在63行添加如下宏定义
#define DEBUG_INPUT_KEY
// 在138行添加如下日志输出。每当我们按下按键触发中断，就会输出相关的按键信息
#ifdef DEBUG_INPUT_KEY
        printk("Debug: volatile: %u V, adc: %d,ref volatage: %d button pressed: %d\n", voltage, val, lradc->vref, keycode);
#endif

```

# 串口驱动

修改linux内核的设备树, 路径 `~/atguigupi/linux/arch/arm/boot/dts/allwinner/sun8i-v3s-atguigupi.dts`

```
	aliases {
		serial2 = &uart2;
	};

&uart2 {
	status = "okay";
};

```

# I2C总线

修改linux内核设备树, 路径 `~/atguigupi/linux/arch/arm/boot/dts/allwinner/sun8i-v3s-atguigupi.dts`

```
	aliases {
		i2c0 = &i2c0;
		i2c1 = &i2c1;
	};

&i2c0 {
	status = "okay";
};
&i2c1 {
	status = "okay";
	pinctrl-names = "default";
	pinctrl-0 = <&i2c1_pe_pins>;
};

```

# 无线网卡

修改linux设备树文件, 路径 `~/atguigupi/linux/arch/arm/boot/dts/allwinner/sun8i-v3s-atguigupi.dts`

```
// 开放mmc1设备，无线网卡挂在这个接口下面
&mmc1 {
	broken-cd;
	bus-width = <4>;
	vmmc-supply = <&reg_vcc3v3>;
	status = "okay";
};

```

修改menuconfig

```
[*] Networking support  --->
  [*]   Wireless  --->
  <*>   cfg80211 - wireless configuration API
  [*]     enable powersave by default
  <*>   Generic IEEE 802.11 Networking Stack (mac80211)
  [*]   Enable mac80211 mesh networking support
  [*]   Select mac80211 debugging features  --->

```

重新编译linux内核

```sh
$ cd ~/atguigupi/linux
$ ARCH=arm CROSS_COMPILE=/home/zuoyuan/atguigupi/toolchain/bin/arm-linux-gnueabihf- make -j$(nproc) zImage
$ ARCH=arm CROSS_COMPILE=/home/zuoyuan/atguigupi/toolchain/bin/arm-linux-gnueabihf- make -j$(nproc) dtbs
# 下面一行非常重要
$ ARCH=arm CROSS_COMPILE=/home/zuoyuan/atguigupi/toolchain/bin/arm-linux-gnueabihf- make -j$(nproc) modules

```

下载esp8089驱动代码

下载地址：`https://github.com/skiinder/esp8089/archive/refs/heads/kernel-6.6.zip`

```sh
$ cd ~/atguigupi
$ git clone https://github.com/skiinder/esp8089.git
$ git checkout kernel-6.6
$ cd esp8089
$ ARCH=arm CROSS_COMPILE=/home/zuoyuan/atguigupi/toolchain/bin/arm-linux-gnueabihf- make -C ../linux/ M=$PWD modules

```

待编译完成，目录中`esp8089.ko`就是驱动文件。

## 重新构建rootfs

```sh
$ cd ~/atguigupi/buildroot
# 获取linux版本号
$ LINUX_RELEASE=$(cat ../linux/include/generated/utsrelease.h | grep UTS_RELEASE | cut -d '"' -f 2)
$ mkdir -p rootfs-overlay/usr/lib/modules/$LINUX_RELEASE
$ cp ../esp8089/esp8089.ko rootfs-overlay/usr/lib/modules/$LINUX_RELEASE/
$ cat <<'EOF' >rootfs-overlay/usr/lib/modules/$LINUX_RELEASE/modules.dep
esp8089.ko:
EOF
$ mkdir -p rootfs-overlay/etc/init.d
$ cat <<'EOF' >rootfs-overlay/etc/init.d/S01esp8089
#/bin/sh

case $1 in
start)
  echo "Installing esp8089: "
  modprobe esp8089 && echo "ok" || echo "fail"
  ;;
stop)
  echo "Uninstalling esp8089: "
  modprobe -r esp8089 && echo "ok" || echo "fail"
  ;;
esac
EOF
$ chmod +x rootfs-overlay/etc/init.d/S01esp8089
$ mkdir -p rootfs-overlay/etc/network
$ cat <<'EOF' >rootfs-overlay/etc/network/interfaces
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet dhcp
  pre-up /etc/network/nfs_check
  wait-delay 15
  hostname $(hostname)

auto wlan0
iface wlan0 inet dhcp
  pre-up /etc/network/nfs_check
  wpa-conf /etc/wpa_supplicant.conf
  wait-delay 15
  hostname $(hostname)
EOF

```

修改menuconfig

```
Target packages  --->
  Networking applications  --->
    [*] wpa_supplicant  --->
      这个分支下面的选项全部选中

```

重新构建rootfs

```sh
$ cd ~/atguigupi/buildroot
$ make

```

